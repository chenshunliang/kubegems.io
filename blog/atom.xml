<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://kubegems.io/kubegems.io/blog</id>
    <title>KubeGems Blog</title>
    <updated>2022-03-22T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://kubegems.io/kubegems.io/blog"/>
    <subtitle>KubeGems Blog</subtitle>
    <icon>https://kubegems.io/kubegems.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[sidecarless-mesh方案可行性验证]]></title>
        <id>sidecarless-mesh</id>
        <link href="https://kubegems.io/kubegems.io/blog/sidecarless-mesh"/>
        <updated>2022-03-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[传统方案与sidecarless方案对比]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="传统方案与sidecarless方案对比">传统方案与sidecarless方案对比<a class="hash-link" href="#传统方案与sidecarless方案对比" title="Direct link to heading">​</a></h2><img src="/img/docs/sidecarless-mesh.webp" width="100%"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="kind-集群搭建步骤">kind 集群搭建步骤<a class="hash-link" href="#kind-集群搭建步骤" title="Direct link to heading">​</a></h2><p>   安装kind请参考<a href="https://kind.sigs.k8s.io/docs/user/quick-start/#installing-from-release-binaries" target="_blank" rel="noopener noreferrer">kind install</a>,假定<code>GOPATH=$HOME/go</code></p><h1>构建kubegems适配的k8s node-image</h1><ul><li><code>mkdir $GOPATH/src/k8s.io &amp;&amp; cd $GOPATH/src/k8s.io</code></li><li><code>git clone https://github.com/kubernetes/kubernets</code></li><li><code>git check -b kubegems_test v1.21.1</code></li><li><code>kind build node-image</code><br>检查是否成功构建镜像<br><code>docker images  | grep kindest/node</code></li></ul><h1>构建k8s集群</h1><p>   需要使用的kind配置文件<code>kind-example-config.yaml</code>  </p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Cluster</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kind.x</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s.io/v1alpha4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kubeadmConfigPatches</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  apiServer:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      v: "4"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  controllerManager:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      v: "4"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  scheduler:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      v: "4"</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  kind: KubeletConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  evictionHard:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    nodefs.available: "0%"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  kind: InitConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  nodeRegistration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    kubeletExtraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      v: "4"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  kind: JoinConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">  nodeRegistration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    kubeletExtraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      v: "4"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networking</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">disableDefaultCNI</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">podSubnet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10.0.0.0/16"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">serviceSubnet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"10.1.0.0/16"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">nodes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> control</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">plane</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> worker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> worker</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><p><strong>NOTE</strong><br>
<!-- -->配置项一定要设置<code>disableDefaultCNI: true</code></p><hr><p>   创建cluster<br>
<code>kind create cluster --config=kind-example-config.yaml --image=kindest/node:latest</code>  </p><h1>安装cilium service-mesh镜像</h1><p>  安装cilium-cli  </p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sha256sum --check cilium-linux-amd64.tar.gz.sha256sum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm cilium-linux-amd64.tar.gz{,.sha256sum}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><p><strong>NOTE</strong><br>
<!-- -->请保障cilium-cli版本 &gt; v0.10.0  </p><hr><p>  使用如下一小段脚本来简化kind上的安装过程,将之命名为<code>load.sh</code></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">ciliumMeshImage</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"quay.io/cilium/cilium-service-mesh:v1.11.0-beta.1"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"quay.io/cilium/operator-generic-service-mesh:v1.11.0-beta.1"</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"quay.io/cilium/hubble-relay-service-mesh:v1.11.0-beta.1"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">i</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${ciliumMeshImage</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">@</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> pull </span><span class="token variable" style="color:#36acaa">$i</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kind load docker-image </span><span class="token variable" style="color:#36acaa">$i</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>   执行<code>./load.sh</code><br>
<!-- -->执行命令</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">   cilium </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> --version -service-mesh:v1.11.0-beta.1 --config enable-envoy-config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true  --datapath-mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vxlan  --kube-proxy-replacement</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">probe </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><p><strong>NOTE</strong><br>
<!-- -->选项解释: </p><ul><li><code>-service-mesh:v1.11.0-beta.1</code>是完整的版本后缀, cilium-cli(&gt;v0.10.0)会通过正则表达式来匹配,请保障不要出错  </li><li><code>enable-envoy-config=true</code> 使能对应的k8s CR</li><li><code>--datapath-mode=vxlan</code> 目前mesh功能还不支持native routing, 必须为tunnel模式,详见issue<br><a href="https://github.com/cilium/cilium-service-mesh-beta/issues/9" target="_blank" rel="noopener noreferrer">L7 traffic examples need tunnelling datapath mode</a></li><li><code>--kube-proxy-replacement=probe</code> 使能bpf相关feature探针, 根据内核版本对bpf的支持能力设置cilium-agent的配置  </li></ul><hr><p>  验证安装结果<code>cilium status</code></p><h1>安装kubegems</h1><p>  详细步骤请参考<a href="https://github.com/kubegems/installer-operator#quick-start" target="_blank" rel="noopener noreferrer">kubegems quick start</a>  </p><h1>验证步骤</h1><ul><li>ingress相关验证 <a href="https://github.com/cilium/cilium-service-mesh-beta/blob/main/kubernetes-ingress/http.md" target="_blank" rel="noopener noreferrer">ingress</a><br>kind版本集群的ingress验证需要修改内核启动参数,因为socket-level的BPF程序暂时无法准确判断上下文是否处于host ns,解决方案是启动full kube-proxy replacement,
这个需要禁止cgroup v1,禁止cgroup v1(ubuntu21.04)命令如下  </li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> /etc/default/grub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+ </span><span class="token assign-left variable" style="color:#36acaa">GRUB_CMDLINE_LINUX</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"cgroup_no_v1=all"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reboot</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>  详细背景分析参见<a href="https://github.com/cilium/cilium-service-mesh-beta/issues/3" target="_blank" rel="noopener noreferrer">issue</a> </p><ul><li>metric相关验证 <a href="https://github.com/cilium/cilium-service-mesh-beta/tree/main/custom-envoy-listener" target="_blank" rel="noopener noreferrer">Open Telemetry</a></li><li>l7 traffic <a href="https://github.com/cilium/cilium-service-mesh-beta/tree/main/l7-traffic-management" target="_blank" rel="noopener noreferrer">L7-aware Traffic Management</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="开发环境搭建工作">开发环境搭建工作<a class="hash-link" href="#开发环境搭建工作" title="Direct link to heading">​</a></h2><p>  待续</p><h1>遇到的问题以及解决方法</h1><ul><li>编译器版本和内核版本的选择
目前我使用的ubuntu21.04,clang-14是有问题的,内核版本较低,但编译器版本较高,推荐ubuntu20.04 LTS + clang-10
我目前提了一些相关issue,待进一步分析解决<br><a href="https://github.com/cilium/cilium/issues/18861" target="_blank" rel="noopener noreferrer">llvm</a><br><a href="https://github.com/cilium/cilium-service-mesh-beta/issues/25" target="_blank" rel="noopener noreferrer">operator</a>  </li><li>iptable模式的k8s限制<br>cilium实现ingress方案较为特殊,没有和istio-gateway/nginx一样建立对应的真实的endpoint POD,只有一个loadbalancer service,这样
直接在虚拟机环境上nodeport方式不工作,因为filter表中会有对应的REJECT规则, 参见k8s源代码<br><a href="https://github.com/kubernetes/kubernetes/blob/18df5ad1fdce9d4f7c9c04a9ea4bdcc7a7400a16/pkg/proxy/iptables/proxier.go#L1177-L1253" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/kubernetes/blob/18df5ad1fdce9d4f7c9c04a9ea4bdcc7a7400a16/pkg/proxy/iptables/proxier.go#L1177-L1253</a></li></ul>]]></content>
        <author>
            <name>zhanghe</name>
            <uri>https://github.com/zhanghe9702</uri>
        </author>
        <category label="ebpf" term="ebpf"/>
        <category label="cilium" term="cilium"/>
        <category label="sidecarless" term="sidecarless"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[登陆和认证设计]]></title>
        <id>kubegems-auth</id>
        <link href="https://kubegems.io/kubegems.io/blog/kubegems-auth"/>
        <updated>2022-03-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[登陆模块]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="登陆模块">登陆模块<a class="hash-link" href="#登陆模块" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="需求">需求<a class="hash-link" href="#需求" title="Direct link to heading">​</a></h3><p>支持多源登陆(ldap, oauth2)</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="登陆设计">登陆设计<a class="hash-link" href="#登陆设计" title="Direct link to heading">​</a></h3><p>插件式设计，允许不同类型的登陆源实现登陆插件即可,插件目前分为两类,分别是<code>OAUTH</code>和<code>LDAP</code></p><p>插件需要实现接口<code>aaa.AuthenticateIface</code>接口</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">type AuthenticateIface interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 返回登陆插件的名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GetName() string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 返回登陆地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LoginAddr() string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // , 获取用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 验证凭据,获取根据用户提供的凭据获取用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GetUserInfo(ctx context.Context, cred *Credential) (*UserInfo, error)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>登陆流程:</p><ol><li><p>LDAP类型和默认账号密码登陆,直接提供登陆的用户和密码以及登陆源即可,登陆后将获得token</p></li><li><p>OAUTH类型，先获取登陆地址，重定向到登陆地址，通常这个登陆地址为第三方平台的认证授权界面，授权后第三方将会重定向到平台配置的一个地址，并且携带着第三方平台的一个授权code,平台通过这个code获取access_token，再带着这个access_token访问用户信息，通过第三方平台中的<code>用户名</code>作为kubegems中的用户，登陆成功后获得token</p></li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="认证设计">认证设计<a class="hash-link" href="#认证设计" title="Direct link to heading">​</a></h3><p>插件式设计，目前仅实现了基于JWT的认证方式; 需要实现接口<code>aaa.UserGetterIface</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">type UserGetterIface interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GetUser(req *http.Request) (u user.CommonUserIface, exist bool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>认证流程</p><p>不同的认证插件, 从请求头中获取需要的信息，例如通过Authorization头获取Bearer token,通过获取到的信息载入用户，如果没有找到用户，则表示未登陆</p>]]></content>
        <author>
            <name>yud</name>
            <uri>https://github.com/pepesi</uri>
        </author>
        <category label="登陆认证" term="登陆认证"/>
        <category label="kubegems" term="kubegems"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[权限设计]]></title>
        <id>kubegems-perms</id>
        <link href="https://kubegems.io/kubegems.io/blog/kubegems-perms"/>
        <updated>2022-03-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[主要数据模型]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="主要数据模型">主要数据模型<a class="hash-link" href="#主要数据模型" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="pic" src="/kubegems.io/assets/images/data-models.drawio-0acc3b60be686e11bcff59ec584bcbb8.svg" width="1131" height="571"></p><p>数据模型的主要层级关系为 <code>租户 -&gt; 项目 -&gt; 环境 -&gt; 应用</code>;</p><p>对应到集群中的以下资源</p><table><thead><tr><th>资源</th><th>简写</th><th>group/version</th><th>是否是namespaced资源</th><th>Crd</th></tr></thead><tbody><tr><td>environments</td><td>tenv</td><td>gems.kubegems.io/v1beta1</td><td>false</td><td>Environment</td></tr><tr><td>tenantgateways</td><td>tgw</td><td>gems.kubegems.io/v1beta1</td><td>false</td><td>TenantGateway</td></tr><tr><td>tenantnetworkpolicies</td><td>tnetpol</td><td>gems.kubegems.io/v1beta1</td><td>false</td><td>TenantNetworkPolicy</td></tr><tr><td>tenantresourcequotas</td><td>tquota</td><td>gems.kubegems.io/v1beta1</td><td>false</td><td>TenantResourceQuota</td></tr><tr><td>tenants</td><td>ten</td><td>gems.kubegems.io/v1beta1</td><td>false</td><td>Tenant</td></tr></tbody></table><ol><li><p>系统内顶级资源为 <code>租户</code> 和 <code>集群</code>,  租户和集群都由系统管理员添加；租户与集群通过<code>TenantResourceQuota</code>关联，一个租户在一个集群下只能存在一个TenantResourceQuota;
租户映射到集群中的CRD为<code>Tenant</code>, 租户CRD下存在<code>网络隔离策略(TenantNetworkPolicy)</code>和<code>资源限制(TenantResourceQuota)</code>以及<code>租户网关(TenantGateway)</code>, 这些子资源都将在租户crd创建的时候默认创建；</p></li><li><p><code>用户(Users)</code>与租户，项目，环境都存在着关联关系，这些关联关系将为以后的用户权限提供数据支持；</p></li><li><p><code>项目</code>仅仅是平台侧的概念，它表示一组应用的集合</p></li><li><p><code>环境</code>与集群的<code>namespace</code>关联，实现环境隔离，资源限制，网络隔离等，环境则更多的是运维相关属性;</p></li><li><p><code>应用</code>表示真实的应用</p></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="用户认证-和-登陆">用户认证 和 登陆<a class="hash-link" href="#用户认证-和-登陆" title="Direct link to heading">​</a></h2><ol><li><p>本地认证，支持账号+密码登陆</p></li><li><p>外部认证，支持ldap和oauth2的认证</p></li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="用户权限">用户权限<a class="hash-link" href="#用户权限" title="Direct link to heading">​</a></h2><p>系统的用户权限主要通过<code>角色</code>实现, <code>角色</code>又分为<code>系统级角色</code>,<code>租户级角色</code>,<code>项目级角色</code>和<code>环境级角色</code>;</p><ol><li>系统级角色</li></ol><ul><li><p>系统管理员</p><p><code>系统管理员</code>的职责是管理系统资源，集群，集群插件，租户等; 系统管理员拥有一切资源的操作权限和读权限
</p></li><li><p>普通用户</p><p>普通用户代表kubgems中的普通成员，用用<code>普通用户</code>角色的账号仅能登陆系统，其他租户，项目等权限将根据租户和项目下的角色判断</p></li></ul><ol start="2"><li>租户级角色</li></ol><ul><li><p>租户管理员</p><p><code>租户管理员</code>的职责是负责租户的成员管理和项目管理,负责项目添加和删除，租户成员的添加和修改; 租户管理员拥有租户下的一切资源操作权限和读权限</p></li><li><p>租户成员</p><p><code>租户成员</code>默认仅可以读租户下的项目信息; 在添加<code>项目成员</code>，<code>环境成员</code>的时候，用户必须是租户成员才能作为项目成员和环境成员的备选项;</p></li></ul><ol start="3"><li>项目级</li></ol><ul><li><p>项目管理员 </p><p><code>项目管理主</code>的职责是负责项目的成员管理，项目的环境管理和项目下的应用管理; 项目管理员拥有项目下的一切资源的操作权限和读权限;</p></li><li><p>项目成员</p><p>项目成员拥有三个角色，分别是<code>开发</code> <code>测试</code> <code>运维</code></p><p>项目<code>开发</code>成员可以读所有环境，只能操作<code>开发</code>类型的环境</p><p>项目<code>测试</code>成员可以读所有环境，只能操作<code>测试</code>类型的环境</p><p>项目<code>运维</code>成员可以读所有环境，可以操作<code>开发</code> <code>测试</code> <code>生产</code>类型的环境
</p></li></ul><ol start="4"><li>环境级</li></ol><ul><li><p>环境reader</p><p>默认情况下，项目成员是所有环境的reader,即只要是<code>项目成员</code>，就能读取所有的环境数据</p></li><li><p>环境operator</p><p>通常不需要配置这个角色，但是有特殊的情况，例如开发需要操作<code>生产</code>环境的资源，默认情况下开发人员只能操作开发环境，这时候授权开发人员在生产环境是operator的角色，就可以操作生产环境了;</p></li></ul>]]></content>
        <author>
            <name>yud</name>
            <uri>https://github.com/pepesi</uri>
        </author>
        <category label="权限设计" term="权限设计"/>
        <category label="kubegems" term="kubegems"/>
    </entry>
</feed>