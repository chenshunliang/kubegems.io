<!doctype html>
<html class="docs-version-current" lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<link rel="alternate" type="application/rss+xml" href="/kubegems.io/blog/rss.xml" title="KubeGems RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/kubegems.io/blog/atom.xml" title="KubeGems Atom Feed"><title data-rh="true">Kubeadm（集群模式） | KubeGems</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://kubegems.io/kubegems.io/docs/installation/kubernetes-installation/kubeadm"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kubeadm（集群模式） | KubeGems"><meta data-rh="true" name="description" content="使用Kubeadm安装"><meta data-rh="true" property="og:description" content="使用Kubeadm安装"><link data-rh="true" rel="icon" href="/kubegems.io/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kubegems.io/kubegems.io/docs/installation/kubernetes-installation/kubeadm"><link data-rh="true" rel="alternate" href="https://kubegems.io/kubegems.io/docs/installation/kubernetes-installation/kubeadm" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://kubegems.io/kubegems.io/docs/installation/kubernetes-installation/kubeadm" hreflang="x-default"><link rel="stylesheet" href="/kubegems.io/assets/css/styles.3d353abb.css">
<link rel="preload" href="/kubegems.io/assets/js/runtime~main.a65d52db.js" as="script">
<link rel="preload" href="/kubegems.io/assets/js/main.e376f640.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/kubegems.io/"><div class="navbar__logo"><img src="/kubegems.io/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/kubegems.io/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/kubegems.io/docs/concepts/what-is-kubegems">文档</a><a class="navbar__item navbar__link" href="/kubegems.io/blog">博客</a><a class="navbar__item navbar__link" href="/kubegems.io/community/support">社群</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/kubegems.io/docs/concepts/what-is-kubegems">v1.20.0-beta.1</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>简体中文</span></span></a><ul class="dropdown__menu"><li><a href="/kubegems.io/docs/installation/kubernetes-installation/kubeadm" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li></ul></div><div class="navbar__items navbar__item--dock"><div class="toggle navbar__toggle toggle--disabled" role="button" tabindex="-1"><div class="toggle__icon toggle__icon--unchecked kubegems-icon icon-light"></div><div class="toggle__icon toggle__icon--checked kubegems-icon icon-dark"></div><input type="checkbox" class="toggle__screenreader-only" aria-label="Switch between dark and light mode"></div><a href="https://github.com/kubegems" target="_blank" rel="noopener noreferrer" class="navbar__github"></a><a href="https://demo.kubegems.io" target="_blank" rel="noopener noreferrer" class="navbar__login button button--primary">登录控制台</a><div class="navbar__login__account"><div class="navbar__login__info">账号: admin</div><div class="navbar__login__info">密码: demo!@#admin</div></div></div></div></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y sidebarWithHideableNavbar_FoYL"><a tabindex="-1" class="sidebarLogo_FJUI" href="/kubegems.io/"><img src="/kubegems.io/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/kubegems.io/img/logo.svg" alt="KubeGems" class="themedImage_W2Cr themedImage--dark_oUvU"></a><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/kubegems.io/docs/concepts/what-is-kubegems">概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/kubegems.io/docs/installation/quick-install">部署指南</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kubegems.io/docs/installation/quick-install">快速安装</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/kubegems.io/docs/installation/kubernetes-installation/kubeadm">安装Kubernetes</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/kubegems.io/docs/installation/kubernetes-installation/kubeadm">Kubeadm（集群模式）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kubegems.io/docs/installation/kubernetes-installation/kind">Kind</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kubegems.io/docs/installation/kubernetes-installation/aks">阿里云（ASK）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kubegems.io/docs/installation/kubernetes-installation/gke">谷歌云（GKE）</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/kubegems.io/docs/installation/more-install-guides/kernel-optimize">更多配置</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/kubegems.io/docs/quick-starts/quick-start">快速入门</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/kubegems.io/docs/tasks/platform/user">使用指南</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/kubegems.io/docs/public/contribute/add-content">参与贡献</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/kubegems.io/docs/reference/customresourcedefinitions">参考</a></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/kubegems.io/">🏠</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">部署指南</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">安装Kubernetes</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/kubegems.io/docs/installation/kubernetes-installation/kubeadm">Kubeadm（集群模式）</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="使用kubeadm安装">使用Kubeadm安装<a class="hash-link" href="#使用kubeadm安装" title="Direct link to heading">​</a></h2><p>本页面显示如何通过kubeadm安装一个3 Master节点的高可用Kubernetes集群。有关在执行此安装过程后如何使用 <strong>kubeadm</strong> 创建集群的信息，请参见kubeadm官方文档。</p><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="准备开始">准备开始<a class="hash-link" href="#准备开始" title="Direct link to heading">​</a></h3><ul><li><p>一台兼容的 Linux 主机。Kubernetes 项目<strong>为基于Debian和Ubuntu</strong>的Linux发行版以及一些不提供包管理器的发行版提供通用的指令</p></li><li><p>每台机器 8 GB 或更多的 RAM （如果少于这个数字将会影响你应用的运行内存)</p></li><li><p>2 CPU 核或更多</p></li><li><p>集群中的所有机器的网络彼此均能相互连接(公网和内网都可以)</p></li><li><p>节点之中不可以有重复的主机名、MAC 地址或 product_uuid。请参见这里了解更多详细信息。</p></li><li><p>开启机器上的某些端口。</p></li><li><p>禁用交换分区。为了保证 kubelet 正常工作，你<strong>必须</strong>禁用交换分区。</p></li></ul><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</h5></div><div class="admonition-content"><p><strong>操作系统推荐使用</strong>Ubuntu Server 1804<strong>以上版本</strong></p></div></div><p><strong>下载kuberentes安装包</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes.1.18.16-with-containerd.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes.1.18.16-with-containerd.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>安装kubernetes组件和containerd</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./libseccomp2_2.4.3-1ubuntu3.18.04.3_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg -i containerd.io_1.4.4-1_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>配置containerd和cri工</strong>具</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s#root = &quot;/var/lib/containerd&quot;#root = &quot;/data/containerd&quot;#&#x27;</span><span class="token plain"> /etc/containerd/config.tom</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>配置kubelet</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">EOF </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_KUBECONFIG_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/var/lib/kubelet/kubeadm-flags.env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/etc/default/kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/kubelet </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBECONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_CONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBEADM_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_EXTRA_ARGS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>导入kuberentes master和etcd镜像</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr ns create k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> api.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> etcd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> manager.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> proxy.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> scheduler.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> coredns.18.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/pause.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> pause.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署etcd高可用集群">部署etcd高可用集群<a class="hash-link" href="#部署etcd高可用集群" title="Direct link to heading">​</a></h3><p><strong>master1节点上创建etcd配置文件</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># HOST地址根据自己的实际服务器地址进行更换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST0</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST1</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.69</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">HOST2</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.70</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/ /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/ /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ETCDHOSTS</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NAMES</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;infra0&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;infra1&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;infra2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token for-or-select variable" style="color:#36acaa">i</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;</span><span class="token string variable" style="color:#36acaa">${</span><span class="token string variable operator" style="color:#393A34">!</span><span class="token string variable" style="color:#36acaa">ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">@</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">HOST</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">$i</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">${NAMES</span><span class="token variable punctuation" style="color:#393A34">[</span><span class="token variable" style="color:#36acaa">$i</span><span class="token variable punctuation" style="color:#393A34">]</span><span class="token variable" style="color:#36acaa">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">&gt;</span><span class="token string bash punctuation" style="color:#393A34"> /tmp/</span><span class="token string bash punctuation variable" style="color:#36acaa">${HOST}</span><span class="token string bash punctuation" style="color:#393A34">/kubeadmcfg.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: &quot;kubeadm.k8s.io/v1beta2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ClusterConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">etcd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    local:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        serverCertSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &quot;</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        peerCertSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        - &quot;</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-cluster: infra0=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">0</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380,infra1=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">1</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380,infra2=https://</span><span class="token string variable" style="color:#36acaa">${ETCDHOSTS</span><span class="token string variable punctuation" style="color:#393A34">[</span><span class="token string variable" style="color:#36acaa">2</span><span class="token string variable punctuation" style="color:#393A34">]</span><span class="token string variable" style="color:#36acaa">}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-cluster-state: new</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            name: </span><span class="token string variable" style="color:#36acaa">${NAME}</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen-peer-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen-client-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            advertise-client-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            initial-advertise-peer-urls: https://</span><span class="token string variable" style="color:#36acaa">${HOST}</span><span class="token string" style="color:#e3116c">:2380</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">done</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>生成etcd集群的证书</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-ca</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -R /etc/kubernetes/pki /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> -R /etc/kubernetes/pki /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain">/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-server --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-peer --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs etcd-healthcheck-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase certs apiserver-etcd-client --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /tmp/</span><span class="token variable" style="color:#36acaa">${HOST2}</span><span class="token plain"> -name ca.key -type f -delete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> /tmp/</span><span class="token variable" style="color:#36acaa">${HOST1}</span><span class="token plain"> -name ca.key -type f -delete</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>拷贝etcd集群证书</strong></p><p>将目录/tmp/\${HOST1}和/tmp/\${HOST2}下的文件分别拷贝到对应master节点的/etc/kubernetes目录下
保证文件结构如下</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0</span><span class="token variable operator" style="color:#393A34">,</span><span class="token variable" style="color:#36acaa">1</span><span class="token variable operator" style="color:#393A34">,</span><span class="token variable" style="color:#36acaa">2}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── kubeadmcfg.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── apiserver-etcd-client.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├── apiserver-etcd-client.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      └── etcd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── ca.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── ca.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── healthcheck-client.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── healthcheck-client.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── peer.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── peer.key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ├── server.crt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          └── server.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>创建etcd实例</strong></p><ul><li>master1节点</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase etcd </span><span class="token builtin class-name">local</span><span class="token plain"> --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/tmp/</span><span class="token variable" style="color:#36acaa">${HOST0}</span><span class="token plain">/kubeadmcfg.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>master2/master3节点</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm init phase etcd </span><span class="token builtin class-name">local</span><span class="token plain"> --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/etc/kubernetes/kubeadmcfg.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>查看etcd集群状态</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">pod_id</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">`</span><span class="token variable" style="color:#36acaa">crictl </span><span class="token variable function" style="color:#d73a49">ps</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> etcd </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{print $1}&#x27;</span><span class="token variable" style="color:#36acaa">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crictl </span><span class="token builtin class-name">exec</span><span class="token plain"> -it </span><span class="token variable" style="color:#36acaa">${pod_id}</span><span class="token plain"> etcdctl </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cert /etc/kubernetes/pki/etcd/peer.crt </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--key /etc/kubernetes/pki/etcd/peer.key </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cacert /etc/kubernetes/pki/etcd/ca.crt </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--endpoints https://10.36.0.68:2379 endpoint health --cluster</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署master集群">部署Master集群<a class="hash-link" href="#部署master集群" title="Direct link to heading">​</a></h3><p><strong>修改kubelet配置文件</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain">EOF </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note: This dropin only works with kubeadm and kubelet v1.11+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf  --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd  --container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">Environment</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/var/lib/kubelet/kubeadm-flags.env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">EnvironmentFile</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">-/etc/default/kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">ExecStart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/bin/kubelet </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBECONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_CONFIG_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_KUBEADM_ARGS</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$KUBELET_EXTRA_ARGS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOF</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart kubelet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl status kubelet</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>生成kubeadm配置</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /root/kubeadm.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">bootstrapTokens:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">- groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - system:bootstrappers:kubeadm:default-node-token</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  token: abcdef.0123456789abcdef</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  ttl: 24h0m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  usages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - signing</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: InitConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">localAPIEndpoint:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### 必配，选着Kubnernetes api的暴露地址，一般为管理网段，地址根据实际情况修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  advertiseAddress: 10.36.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  bindPort: 6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">nodeRegistration:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  criSocket: /run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### 必配，选着Kubnernetes master的hostname</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  name: l-010036000068-k8s.cloudminds.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  taints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - effect: NoSchedule</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    key: node-role.kubernetes.io/master</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubeadm.k8s.io/v1beta2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: ClusterConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kubernetesVersion: v1.18.16</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">imageRepository: k8s.gcr.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">clusterName: kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">certificatesDir: /etc/kubernetes/pki</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">dns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  type: CoreDNS</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">etcd:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  external:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    endpoints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### 必配, 外部etcd集群的连接地址,地址根据实际情况修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - https://10.36.0.68:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - https://10.36.0.69:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - https://10.36.0.70:2379</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### 必配，保持默认路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    caFile: &quot;/etc/kubernetes/pki/etcd/ca.crt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    certFile: &quot;/etc/kubernetes/pki/apiserver-etcd-client.crt&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    keyFile: &quot;/etc/kubernetes/pki/apiserver-etcd-client.key&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">networking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  dnsDomain: cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  serviceSubnet: 10.96.0.0/12</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### 必配，calico后期如果要用bgp协议，需要提前规划</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  podSubnet: &quot;172.16.0.0/16&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiServer:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  # 打开apiserver的审计日志</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  extraArgs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-path: /var/log/kube-apiserver.audit.log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-policy-file: /etc/kubernetes/audit.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-maxage: &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-maxsize: &quot;100&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    audit-log-maxbackup: &quot;1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  extraVolumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - name: audit</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      hostPath: /etc/kubernetes/audit.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      mountPath: /etc/kubernetes/audit.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      readOnly: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      pathType: File</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    - name: audit-log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      hostPath: /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      mountPath: /var/log</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  timeoutForControlPlane: 4m0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  certSANs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### 必配，api服务的证书签名ip和域名,地址根据实际情况修改</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.0.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.0.69</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.0.70</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.13.145</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.13.146</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - 10.36.13.147</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">controllerManager: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">scheduler: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: KubeProxyConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 开启ipvs模式，可选择iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">mode: &quot;ipvs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># nodeport绑定地址,1.1.1.0/24就只绑定在这个网段</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">nodePortAddresses: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># nodeport的端口范围</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">portRange:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">configSyncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">### 必配</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 容器的CIDR网段，用来做snat地址伪装</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">clusterCIDR: 10.156.0.0/16</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 关闭设置conntrack跟踪表</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">conntrack:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  maxPerCore: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  min: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpCloseWaitTimeout: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpEstablishedTimeout: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 关闭ipvs的设置，以操作系统初始化为主</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">ipvs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  excludeCIDRs: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  minSyncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  scheduler: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  strictARP: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  syncPeriod: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpFinTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcpTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  udpTimeout: 0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: kubelet.config.k8s.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: KubeletConfiguration</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">maxPods: 250</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 此配置保证了 kubelet 能在 swap 开启的情况下启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">failSwapOn: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 初始镜像GC的磁盘占比触发</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">imageGCLowThresholdPercent: 75</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># 超过85¥后一直运行镜像GC</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">imageGCHighThresholdPercent: 85</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># kubelet预留资源，根据配置设置</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#kubeReserved:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#  &quot;cpu&quot;: &quot;500m&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#  &quot;memory&quot;: &quot;512Mi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">#  &quot;ephemeral-storage&quot;: &quot;1Gi&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c"># kubelet证书轮转</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">rotateCertificates: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">featureGates:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  EphemeralContainers: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/kubernetes/audit.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: audit.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">omitStages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - &quot;ResponseStarted&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - level: RequestResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>初始化kubernets master1节点</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">swapoff -a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm  init </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/root/kubeadm.conf </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /var/run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--feature-gates </span><span class="token assign-left variable" style="color:#36acaa">EphemeralContainers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true,ServiceAppProtocol</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>拷贝kubectl配置文件</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /root/.kube</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> /etc/kubernetes/admin.conf  /root/.kube/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">chown</span><span class="token plain"> -R root.root/root/.kube/config </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm token create --ttl </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>master2/master3 节点安装</strong></p><ul><li>加入kubernetes集群</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10.36</span><span class="token plain">.0.68:6443 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token wi0cmt.0o8xodk3thphulkj </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:ae184f561109c7aecfadaa12a5bf6d871c6a0cced0ff4f77313b4639f0fd8f33 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>注意</h5></div><div class="admonition-content"><p><code>token</code>为kubeadm初始化后提供.<br>
<code>discovery-token-ca-cert-hash</code>为kubeadm初始化后提供。</p></div></div><ul><li>master1节点打包配置文件</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> cvzf api.config.tar.gz admin.conf audit.yaml controller-manager.conf scheduler.conf pki/sa.key pki/sa.pub pki/front-proxy-client.crt pki/front-proxy-client.key pki/front-proxy-ca.key pki/front-proxy-ca.crt pki/apiserver-kubelet-client.crt pki/apiserver-kubelet-client.key pki/apiserver.crt pki/apiserver.key pki/ca.key</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>将<code>api.config.tar.gz</code>拷贝到master2，master3节点</li></ul><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mv api.config.tar.gz /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar xf api.config.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><ul><li>创建Kubernetes auth规则</li></ul><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /etc/kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/kubernetes/audit.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">apiVersion: audit.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">kind: Policy</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">omitStages:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - &quot;ResponseStarted&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  - level: RequestResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>拷贝api组件manifest文件</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> /etc/kubernetes/manifests/kube-scheduler.yaml</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>注意</h5></div><div class="admonition-content"><p><code>kube-apiserver.yaml</code> 文件拷贝到master2和master3上时，需要将文件中的master1节点ip信息换成对应机器上的ip。</p></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署kubelet节点">部署Kubelet节点<a class="hash-link" href="#部署kubelet节点" title="Direct link to heading">​</a></h3><p><strong>容器数据盘</strong></p><p>根据服务器上的硬盘灵活规划数据盘的挂载，通常将sdb设备格式化后挂在到<code>/data</code>目录下</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">msfs.xfs /dev/sdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> /dev/sdb /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/dev/sdb    none            xfs   defaults      0       0&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/fstab</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</h5></div><div class="admonition-content"><p><strong>sdb设备要灵活选择，要保证数据的安全性，如果服务器有多块硬盘的话，至少要做RAID1以上的模式</strong></p></div></div><p><strong>配置nginx，反向代理到kubernets api</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/nginx/nginx.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">user root;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_processes 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_cpu_affinity auto;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">pid /run/nginx.pid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">load_module  /usr/share/nginx/modules/ngx_stream_module.so;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_rlimit_nofile 64512;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_shutdown_timeout 10s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">events {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    multi_accept        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    worker_connections  16384;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    use                 epoll;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">stream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    upstream upstream_balancer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            least_conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            # kubernetes master的api地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.68:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.69:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 10.36.0.70:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    log_format log_stream [</span><span class="token string variable" style="color:#36acaa">$time_local</span><span class="token string" style="color:#e3116c">] </span><span class="token string variable" style="color:#36acaa">$protocol</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$status</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_sent</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_received</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$session_time</span><span class="token string" style="color:#e3116c">;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    access_log /var/log/nginx/access.log log_stream ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    error_log  /var/log/nginx/error.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen 127.0.0.1:6443;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_timeout 1200s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_pass upstream_balancer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx -t </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> nginx -s reload </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>下载kubernetes安装包</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes.1.18.16-with-containerd.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>安装kubernetes和containerd</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./libseccomp2_2.4.3-1ubuntu3.18.04.3_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg -i containerd.io_1.4.4-1_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y --allow-change-held-packages ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>配置containerd和cri工具</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> containerd config default </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tee</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sed</span><span class="token plain"> -i </span><span class="token string" style="color:#e3116c">&#x27;s#root = &quot;/var/lib/containerd&quot;#root = &quot;/data/containerd&quot;#&#x27;</span><span class="token plain"> /etc/containerd/config.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>导入Container镜像</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr ns create k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images </span><span class="token function" style="color:#d73a49">import</span><span class="token plain"> proxy.18.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>清除安装文件</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /root </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><p><strong>加入kuernetes集群</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm </span><span class="token function" style="color:#d73a49">join</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:6443 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token wi0cmt.0o8xodk3thphulkj </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:ae184f561109c7aecfadaa12a5bf6d871c6a0cced0ff4f77313b4639f0fd8f33 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>注意</h5></div><div class="admonition-content"><p><code>token</code>为kubeadm初始化后提供.<br>
<code>discovery-token-ca-cert-hash</code>为kubeadm初始化后提供。</p></div></div><hr><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="部署kubelet节点gpu">部署Kubelet节点(GPU)<a class="hash-link" href="#部署kubelet节点gpu" title="Direct link to heading">​</a></h3><p><strong>容器数据盘</strong></p><p>根据服务器上的硬盘灵活规划数据盘的挂载，通常将sdb设备格式化后挂在到<code>/data</code>目录下</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mkfs.xfs /dev/sdb -f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mount</span><span class="token plain"> /dev/sdb /data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/dev/sdb    /data xfs   defaults      0       0&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/fstab</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</h5></div><div class="admonition-content"><p><strong>sdb设备要灵活选择，要保证数据的安全性，如果服务器有多块硬盘的话，至少要做RAID1以上的模式</strong></p></div></div><p><strong>配置nginx，反向代理到kubernets api</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/nginx/nginx.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">user root;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_processes 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_cpu_affinity auto;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">pid /run/nginx.pid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">load_module  /usr/share/nginx/modules/ngx_stream_module.so;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_rlimit_nofile 64512;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">worker_shutdown_timeout 10s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">events {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    multi_accept        on;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    worker_connections  16384;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    use                 epoll;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">stream {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    upstream upstream_balancer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            least_conn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            # kubernetes master的api地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 172.16.13.134:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 172.16.13.135:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            server 172.16.13.136:6443 max_fails=2 fail_timeout=20s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    log_format log_stream [</span><span class="token string variable" style="color:#36acaa">$time_local</span><span class="token string" style="color:#e3116c">] </span><span class="token string variable" style="color:#36acaa">$protocol</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$status</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_sent</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$bytes_received</span><span class="token string" style="color:#e3116c"> </span><span class="token string variable" style="color:#36acaa">$session_time</span><span class="token string" style="color:#e3116c">;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    access_log /var/log/nginx/access.log log_stream ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    error_log  /var/log/nginx/error.log;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            listen 127.0.0.1:6443;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_timeout 1200s;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">            proxy_pass upstream_balancer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nginx -t </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> nginx -s reload </span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>下载kubernetes安装包</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubernetes.1.18.16-with-containerd.tar.gz </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf kubernetes.1.18.16-with-containerd.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>安装kubernetes和containerd</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./libseccomp2_2.4.3-1ubuntu3.18.04.3_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dpkg -i containerd.io_1.4.4-1_amd64.deb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>安装contaienrd nvidia runtime</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://dumps.cloudminds.com/DOCKERFILE/kubelet/containerd-nvidia-1.18.16.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf containerd-nvidia-1.18.16.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf containerd-nvidia-1.18.16.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -y ./*.deb</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>配置containerd和cri工具</strong></p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx bash"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/modules-load.d/containerd.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe overlay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> modprobe br_netfilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/sysctl.d/99-kubernetes-cri.conf</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-iptables  = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.ipv4.ip_forward                 = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">net.bridge.bridge-nf-call-ip6tables = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply sysctl params without reboot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> sysctl --system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/crictl.yaml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">image-endpoint: unix:///run/containerd/containerd.sock</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">timeout: 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">debug: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /etc/containerd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cat</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">EOF</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation operator" style="color:#393A34">|</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">sudo</span><span class="token string bash punctuation" style="color:#393A34"> </span><span class="token string bash punctuation function" style="color:#d73a49">tee</span><span class="token string bash punctuation" style="color:#393A34"> /etc/containerd/config.toml</span><span class="token string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">version = 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">root = &quot;/data/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">state = &quot;/run/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">plugin_dir = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">disabled_plugins = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">required_plugins = []</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">oom_score = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[grpc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;/run/containerd/containerd.sock&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_tls_cert = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  tcp_tls_key = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  max_recv_message_size = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  max_send_message_size = 16777216</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[ttrpc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[debug]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  uid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  gid = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  level = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[metrics]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  address = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  grpc_histogram = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[cgroup]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  path = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[timeouts]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.cleanup&quot; = &quot;5s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.load&quot; = &quot;5s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.shim.shutdown&quot; = &quot;3s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  &quot;io.containerd.timeout.task.state&quot; = &quot;2s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">[plugins]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    pause_threshold = 0.02</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    deletion_threshold = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    mutation_threshold = 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    schedule_delay = &quot;0s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    startup_delay = &quot;100ms&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_tcp_service = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_server_address = &quot;127.0.0.1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_server_port = &quot;0&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stream_idle_timeout = &quot;4h0m0s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enable_selinux = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    selinux_category_range = 1024</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    sandbox_image = &quot;k8s.gcr.io/pause:3.2&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    stats_collect_period = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    systemd_cgroup = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    enable_tls_streaming = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    max_container_log_line_size = 16384</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_cgroup = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_apparmor = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    restrict_oom_score_adj = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    max_concurrent_downloads = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_proc_mount = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    unset_seccomp_profile = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    tolerate_missing_hugetlb_controller = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    disable_hugetlb_controller = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    ignore_image_defined_volumes = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      snapshotter = &quot;overlayfs&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      default_runtime_name = &quot;runc&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      no_pivot = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      disable_snapshot_annotations = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      discard_unpacked_layers = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_type = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.untrusted_workload_runtime]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_type = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_type = &quot;io.containerd.runtime.v1.linux&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_engine = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          privileged_without_host_devices = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          base_runtime_spec = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      bin_dir = &quot;/opt/cni/bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      conf_dir = &quot;/etc/cni/net.d&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      max_conf_num = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      conf_template = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">          endpoint = [&quot;https://registry-1.docker.io&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.image_decryption]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      key_model = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.x509_key_pair_streaming]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      tls_cert_file = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">      tls_key_file = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.internal.v1.opt&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    path = &quot;/opt/containerd&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.internal.v1.restart&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    interval = &quot;10s&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.metadata.v1.bolt&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    content_sharing_policy = &quot;shared&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.monitor.v1.cgroups&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    no_prometheus = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.runtime.v1.linux&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    shim = &quot;containerd-shim&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    runtime = &quot;nvidia-container-runtime&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    runtime_root = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    no_shim = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    shim_debug = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.runtime.v2.task&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    platforms = [&quot;linux/amd64&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.service.v1.diff-service&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    default = [&quot;walking&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">  [plugins.&quot;io.containerd.snapshotter.v1.devmapper&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    root_path = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    pool_name = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    base_image_size = &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">    async_remove = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">EOF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart containerd</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>导入Container镜像</strong></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://dumps.cloudminds.com/DOCKERFILE/kubelet/kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tar xf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -rf kubernetes-1.18.16-images.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr ns create k8s.io</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ctr -n k8s.io images import proxy.18.tar.gz</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>清除安装文件</strong></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">cd /root &amp;&amp; rm -rf root</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>加入kuernetes集群</strong></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">kubeadm join 127.0.0.1:6443 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--token k9brva.g7vj4109keb0c093 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--discovery-token-ca-cert-hash sha256:72986af040b0dc8e251ee85f774120844e9b64c26bfff547348ef0e669a0f208 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cri-socket /run/containerd/containerd.sock \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--ignore-preflight-errors all</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>注意</h5></div><div class="admonition-content"><p><code>token</code>为kubeadm初始化后提供。<br>
<code>discovery-token-ca-cert-hash</code>为kubeadm初始化后提供。</p></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kubegems.io/docs/installation/quick-install"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">快速安装</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kubegems.io/docs/installation/kubernetes-installation/kind"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kind</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#使用kubeadm安装" class="table-of-contents__link toc-highlight">使用Kubeadm安装</a><ul><li><a href="#准备开始" class="table-of-contents__link toc-highlight">准备开始</a></li><li><a href="#部署etcd高可用集群" class="table-of-contents__link toc-highlight">部署etcd高可用集群</a></li><li><a href="#部署master集群" class="table-of-contents__link toc-highlight">部署Master集群</a></li><li><a href="#部署kubelet节点" class="table-of-contents__link toc-highlight">部署Kubelet节点</a></li><li><a href="#部署kubelet节点gpu" class="table-of-contents__link toc-highlight">部署Kubelet节点(GPU)</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer" id="footer"><div class="text--center">Copyright © 2022 KubeGems, Inc.</div></footer></div>
<script src="/kubegems.io/assets/js/runtime~main.a65d52db.js"></script>
<script src="/kubegems.io/assets/js/main.e376f640.js"></script>
</body>
</html>